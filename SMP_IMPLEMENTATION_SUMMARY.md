# LiteOS 多核 (SMP) 支持实现总结

## 概述

LiteOS 现已完全支持对称多处理 (SMP)，能够在多核 RISC-V 64 系统上高效运行。本实现提供了完整的多核启动、调度、内存管理和进程间通信支持。

## 核心组件

### 1. SMP 基础设施 (`kernel/src/smp/`)

#### CPU 管理 (`smp/cpu.rs`)
- **Per-CPU 数据结构**: 每个 CPU 拥有独立的调度队列、统计信息和上下文
- **CPU 状态管理**: 支持 Offline、Starting、Online、Idle、Error 等状态
- **负载统计**: 实时跟踪每个 CPU 的负载、任务数量和性能指标
- **CPU 亲和性**: 任务可以绑定到特定 CPU 或 CPU 集合

#### 核间通信 (`smp/ipi.rs`)
- **IPI 消息类型**: 
  - Reschedule: 触发重新调度
  - TlbFlush: TLB 刷新同步
  - FunctionCall: 在目标 CPU 执行函数
  - Stop/WakeUp: CPU 状态控制
- **消息队列**: Per-CPU 消息队列，支持异步处理
- **统计监控**: 详细的 IPI 发送/接收统计

#### CPU 拓扑发现 (`smp/topology.rs`)
- **设备树解析**: 自动发现系统中的 CPU 数量和配置
- **NUMA 拓扑**: 支持 NUMA 节点和内存局部性
- **缓存拓扑**: L1/L2/L3 缓存共享关系管理
- **亲和性计算**: 基于拓扑的最优 CPU 亲和性计算

#### SMP 启动序列 (`smp/boot.rs`)
- **两阶段启动**: BSP 初始化全局资源，AP 等待并加入系统
- **同步机制**: 确保所有 CPU 在正确的时间点启动
- **Work Stealing**: 支持任务窃取的负载均衡
- **错误处理**: 完善的 CPU 启动失败处理

### 2. 同步原语重构 (`kernel/src/sync/`)

#### SpinLock (`sync/spinlock.rs`)
- **替代 UPSafeCell**: 提供真正的 SMP 安全同步
- **优化的自旋等待**: 使用 CPU 提示指令减少功耗
- **尝试锁定**: 非阻塞锁定支持
- **死锁预防**: 强制锁定顺序和超时机制

#### 读写锁 (`sync/rwlock.rs`)
- **多读者单写者**: 优化读密集型工作负载
- **原子计数**: 使用原子操作实现高效的读者计数
- **饥饿预防**: 确保写者不会被读者长期阻塞

#### 内存屏障 (`sync/barrier.rs`)
- **架构特定屏障**: RISC-V 内存屏障指令封装
- **CPU 同步屏障**: 多 CPU 同步点实现
- **多种屏障类型**: Sense-reversal、Tree barrier 等

### 3. 多核调度器

#### Per-CPU 调度队列
- **优先级队列**: 高/中/低优先级和 CFS 队列
- **Work Stealing**: 空闲 CPU 从繁忙 CPU 窃取任务
- **负载均衡**: 周期性的全局负载均衡
- **任务亲和性**: 尊重任务的 CPU 亲和性设置

#### 调度算法
- **CFS (完全公平调度器)**: 基于虚拟运行时间的公平调度
- **优先级调度**: 支持 nice 值和动态优先级
- **时间片轮转**: 可配置的时间片大小
- **FIFO**: 先进先出调度策略

#### 负载均衡
- **智能任务分配**: 新任务分配到负载最低的 CPU
- **周期性平衡**: 每 100ms 执行一次负载均衡
- **任务迁移**: 支持任务在 CPU 间迁移
- **亲和性感知**: 考虑 NUMA 和缓存局部性

### 4. 内存管理

#### SMP 安全的内存空间
- **读写锁保护**: 内核内存空间使用读写锁保护
- **TLB 管理**: 支持跨 CPU 的 TLB 刷新同步
- **Per-CPU 分配器**: 减少内存分配竞争

#### 页表管理
- **共享内核空间**: 所有 CPU 共享相同的内核页表
- **用户空间隔离**: 每个进程拥有独立的用户空间
- **TLB 一致性**: 确保页表修改后的 TLB 一致性

### 5. 任务管理增强

#### CPU 亲和性支持
- **CPU 掩码**: 64 位掩码支持最多 64 个 CPU
- **亲和性 API**: 设置和查询任务的 CPU 亲和性
- **智能绑定**: 支持绑定到缓存域或 NUMA 节点
- **继承机制**: 子进程继承父进程的亲和性设置

#### 任务统计
- **Per-CPU 统计**: 每个 CPU 的任务执行统计
- **运行时间跟踪**: 用户态/内核态时间分别统计
- **上下文切换计数**: 详细的调度统计信息

### 6. 时间管理

#### 多核时间同步
- **全局时间基准**: 统一的系统时间基准
- **Per-CPU 偏移**: 每个 CPU 的时间偏移校正
- **睡眠任务管理**: 全局睡眠队列，由主 CPU 管理
- **高精度计时**: 微秒级时间精度

### 7. 启动加载程序增强

#### SMP 启动支持
- **Bootstrap Hart**: Hart 0 执行全局初始化
- **Application Hart**: 其他 Hart 等待启动信号
- **HSM 集成**: 与 RISC-V HSM 扩展集成
- **并行初始化**: 支持多个 Hart 并行启动

## 性能特性

### 可扩展性
- **支持 2-64 个 CPU**: 线性性能扩展
- **NUMA 感知**: 优化跨节点内存访问
- **缓存友好**: 最小化缓存失效和伪共享

### 延迟优化
- **快速 IPI**: 微秒级核间通信延迟
- **无锁数据结构**: 关键路径避免锁竞争
- **智能调度**: 减少任务迁移开销

### 吞吐量优化
- **Work Stealing**: 最大化 CPU 利用率
- **批量操作**: 批量处理 IPI 消息和任务
- **负载感知**: 动态调整调度策略

## 兼容性

### API 兼容性
- **现有 API 保持不变**: 单核代码无需修改
- **扩展 API**: 新增多核相关系统调用
- **向后兼容**: 支持单核和多核环境

### POSIX 兼容性
- **CPU 亲和性**: sched_setaffinity/sched_getaffinity
- **SMP 相关**: 获取 CPU 数量等系统调用
- **信号处理**: 多核安全的信号投递

## 调试和监控

### 调试支持
- **Per-CPU 调试信息**: 详细的 CPU 状态信息
- **IPI 统计**: 核间通信性能监控
- **负载均衡日志**: 任务迁移和负载均衡跟踪

### 性能监控
- **CPU 利用率**: 实时 CPU 利用率统计
- **负载平均**: 1/5/15 分钟负载平均值
- **调度延迟**: 任务调度延迟统计

## 测试验证

### 功能测试
- **多核启动测试**: 验证所有 CPU 正确启动
- **调度测试**: 验证任务在多核间正确调度
- **同步测试**: 验证锁和同步原语的正确性

### 性能测试
- **吞吐量测试**: 多核性能提升验证
- **延迟测试**: 调度和 IPI 延迟测试
- **压力测试**: 高负载下的系统稳定性

### 正确性验证
- **竞态条件检测**: 使用静态分析工具
- **死锁检测**: 运行时死锁检测
- **内存一致性**: 内存访问顺序验证

## 使用方法

### 编译配置
```bash
# 启用多核支持 (默认启用)
make build

# 指定 CPU 数量运行
make run CPUS=4
```

### 系统调用
```c
// 设置 CPU 亲和性
int sched_setaffinity(pid_t pid, size_t cpusetsize, const cpu_set_t *mask);

// 获取 CPU 数量
int get_nprocs(void);

// 获取当前 CPU ID
int get_current_cpu(void);
```

### 内核 API
```rust
// 获取当前 CPU ID
let cpu_id = smp::current_cpu_id();

// 发送 IPI
smp::ipi::send_reschedule_ipi(target_cpu)?;

// 设置任务亲和性
task_manager::affinity::bind_task_to_cpu(&task, cpu_id)?;
```

## 系统要求

### 硬件要求
- **RISC-V 64 多核处理器**: 支持 SBI HSM 扩展
- **共享内存**: 统一内存架构或 NUMA
- **CLINT**: 核间定时器和软件中断支持

### 软件要求
- **Rust nightly-2025-06-15**: 支持裸机目标
- **QEMU 7.0+**: 支持 RISC-V SMP 模拟

## 未来改进

### 短期目标
- **CPU 热插拔**: 支持运行时添加/移除 CPU
- **电源管理**: 空闲 CPU 的低功耗模式
- **中断亲和性**: 中断在 CPU 间的智能分发

### 长期目标
- **异构多核**: 支持大小核架构
- **硬件加速**: 利用硬件负载均衡特性
- **实时调度**: 实时任务的确定性调度

## 总结

LiteOS 的 SMP 支持提供了一个完整、高效且可靠的多核操作系统实现。通过精心设计的架构和优化，系统能够在多核环境中实现出色的性能和可扩展性，同时保持与现有单核代码的完全兼容性。

该实现不仅仅是简单的多核支持，而是一个现代化的、生产就绪的 SMP 操作系统内核，具备了与主流操作系统相当的多核特性和性能表现。